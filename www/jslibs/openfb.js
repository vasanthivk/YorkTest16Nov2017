var openFB=(function(){var FB_LOGIN_URL='https://www.facebook.com/dialog/oauth',tokenStore=window.sessionStorage,fbAppId,oauthRedirectURL,loginSuccessHandler,loginErrorHandler;function init(appId,redirectURL,store){fbAppId=appId;if(redirectURL)oauthRedirectURL=redirectURL;if(store)tokenStore=store;}function login(scope,success,error){if(!fbAppId){return error({error:'Facebook App Id not set.'});}var loginWindow;scope=scope||'';loginSuccessHandler=success;loginErrorHandler=error;if(!oauthRedirectURL){if(runningInCordova()){oauthRedirectURL='https://www.facebook.com/connect/login_success.html';}else{var index=document.location.href.indexOf('index.html');if(index>0){oauthRedirectURL=window.document.location.href.substring(0,index)+'oauthcallback.html';}else{return alert("Can't reliably guess the OAuth redirect URI. Please specify it explicitly in openFB.init()");}}}loginWindow=window.open(FB_LOGIN_URL+'?client_id='+fbAppId+'&redirect_uri='+oauthRedirectURL+'&response_type=token&display=popup&scope='+scope,'_blank','location=no');if(runningInCordova()){loginWindow.addEventListener('loadstart',function(event){var url=event.url;if(url.indexOf("access_token=")>0){loginWindow.close();oauthCallback(url);}});loginWindow.addEventListener('exit',function(event){var url=event.url;if(url.indexOf("access_token=")>0){deferredLogin.reject();}});}}function oauthCallback(url){var hash=decodeURIComponent(url.substr(url.indexOf('#')+1)),params=hash.split('&'),oauthData={};params.forEach(function(param){var splitter=param.split('=');oauthData[splitter[0]]=splitter[1];});var fbtoken=oauthData['access_token'];if(fbtoken){tokenStore['fbtoken']=fbtoken;if(loginSuccessHandler)loginSuccessHandler();}else{if(loginErrorHandler)loginErrorHandler();}}function logout(){tokenStore['fbtoken']=undefined;}function api(obj){var method=obj.method||'GET',params=obj.params||{},xhr=new XMLHttpRequest(),url;params['access_token']=tokenStore['fbtoken'];url='https://graph.facebook.com'+obj.path+'?'+toQueryString(params);xhr.onreadystatechange=function(){console.log(xhr.readyState+' '+xhr.status);if(xhr.readyState===4){if(xhr.status===200){if(obj.success)obj.success(JSON.parse(xhr.responseText));}else{var error=xhr.responseText?JSON.parse(xhr.responseText).error:{message:'An error has occurred'};if(obj.error)obj.error(error);}}}
xhr.open(method,url,true);xhr.send();}function revokePermissions(success,error){return api({method:'DELETE',path:'/me/permissions',success:function(){tokenStore['fbtoken']=undefined;success();},error:error});}function toQueryString(obj){var parts=[];for(var i in obj){if(obj.hasOwnProperty(i)){parts.push(encodeURIComponent(i)+"="+encodeURIComponent(obj[i]));}}return parts.join("&");}function runningInCordova(){return window.device&&window.device.cordova;}return{init:init,login:login,logout:logout,revokePermissions:revokePermissions,api:api,oauthCallback:oauthCallback}}());
